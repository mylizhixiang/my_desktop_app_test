name: Build Flutter Linux App

on:
  push:
    branches: [main,master]  # 指定触发分支
  pull_request:
    branches: [main,master]
  # 若需通过标签触发发布（可选）
#   release:
#     types: [created]

jobs:
  build-linux:
    runs-on: ubuntu-latest
    container:
      image: centos:7
      # 禁止挂载宿主机的 Node 环境
      options: --privileged --volume /__e 

    steps:
    #   - name: Install Legacy Node.js (Fix Edition)
    #     run: |
    #        # STEP 1 - 修复镜像源
    #        # 删除旧镜像配置
    #        rm -rf /etc/yum.repos.d/CentOS-*
    #        # 写入新的 Vault 源配置
    #        cat <<EOF > /etc/yum.repos.d/CentOS-Base.repo
    #        [base]
    #        name=CentOS-\$releasever - Base
    #        baseurl=http://vault.centos.org/centos/\$releasever/os/\$basearch/
    #        gpgcheck=1
    #        gpgkey=file:///etc/pki/rpm-gpg/RPM-GPG-KEY-CentOS-7
    
    #        [updates]
    #        name=CentOS-\$releasever - Updates
    #        baseurl=http://vault.centos.org/centos/\$releasever/updates/\$basearch/
    #        gpgcheck=1
    #        gpgkey=file:///etc/pki/rpm-gpg/RPM-GPG-KEY-CentOS-7
    
    #        [extras]
    #        name=CentOS-\$releasever - Extras
    #        baseurl=http://vault.centos.org/centos/\$releasever/extras/\$basearch/
    #        gpgcheck=1
    #        gpgkey=file:///etc/pki/rpm-gpg/RPM-GPG-KEY-CentOS-7
    #        EOF

    #        # STEP 2 - 更新软件源
    #        yum clean all
    #        yum -y update ca-certificates curl
    #        yum -y install epel-release

    #        # STEP 3 - 安装 Node 16
    #        curl -sL https://rpm.nodesource.com/setup_16.x | bash -
    #        yum -y install nodejs

      # ----- 手工安装低版本 Node.js -----
      - name: Install Node.js via Binary
        run: |
           # 下载 Node.js 16 二进制包
           curl -O https://nodejs.org/dist/v16.20.2/node-v16.20.2-linux-x64.tar.xz
           tar -xf node-v16.20.2-linux-x64.tar.xz
           # 部署到系统路径
           mv node-v16.20.2-linux-x64 /opt/node
           ln -s /opt/node/bin/node /usr/local/bin/node
           ln -s /opt/node/bin/npm /usr/local/bin/npm
           # 验证
           node --version

      # ------------ 环境准备 ------------
      - name: Checkout code
        uses: actions/checkout@v4

      # ------------ 安装构建依赖 ------------
      - name: Install CentOS dependencies
        run: |
          # 修复仓库源（关键！）
          sed -i 's/mirrorlist/#mirrorlist/g' /etc/yum.repos.d/CentOS-*
          sed -i 's|#baseurl=http://mirror.centos.org|baseurl=http://vault.centos.org|g' /etc/yum.repos.d/CentOS-*
          
          yum -y update
          yum -y install centos-release-scl epel-release
          yum -y install devtoolset-9-gcc* clang cmake ninja-build gtk3-devel \
            libxkbcommon-x11-devel libstdc++-static rpm-build redhat-rpm-config
          # 激活新版本的 GCC
        #   echo "source /opt/rh/devtoolset-9/enable" >> ~/.bashrc

      # ------------ 配置 Flutter SDK ------------
      - name: Install Flutter SDK manually
        run: |
          wget https://storage.googleapis.com/flutter_infra_release/releases/stable/linux/flutter_linux_3.22.4-stable.tar.xz
          tar -xf flutter_linux_3.22.4-stable.tar.xz
          echo "$GITHUB_WORKSPACE/flutter/bin" >> $GITHUB_PATH
          # Flutter 初始化
          source /opt/rh/devtoolset-9/enable && flutter doctor -v

      # ------------ 配置 Linux 构建支持 ------------
      - name: Enable Linux desktop
        run: |
          source /opt/rh/devtoolset-9/enable
          flutter config --enable-linux-desktop

      # ------------ 代码测试（可选） ------------
    #   - name: Run tests
    #     run: flutter test

      # ------------ 构建 Release 版本 ------------
      - name: Build Linux app for CentOS
        run: |
          source /opt/rh/devtoolset-9/enable  # 确保使用新编译器
          echo "Current GCC: $(gcc --version | head -1)"
          flutter build linux --release --target-platform=linux-x64

      # ------------ 打包 RPM 安装包 ------------
      - name: Create RPM package
        run: |
          source /opt/rh/devtoolset-9/enable
          # 设置目录结构
          mkdir -p ~/rpmbuild/{BUILD,RPMS,SOURCES,SPECS,SRPMS}
          # 复制构建产到 BUILD 目录（注意目录名！假设项目名是 "my-desktop-app"）
          cp -r build/linux/x64/release/bundle ~/rpmbuild/BUILD/my-desktop-app
          # 完整写入 SPEC 文件（直接替换名称即可使用）
          cat << 'EOF' > ~/rpmbuild/SPECS/my-desktop-app.spec
          %define _topdir %(echo ~)/rpmbuild
          Name: my-desktop-app
          Version: 1.0.0
          Release: 1%{?dist}
          Summary: My Flutter App for CentOS
          License: MIT
          URL: https://github.com/mylizhixiang/my_desktop_app_test
          Requires: gtk3, libstdc++
          BuildArch: x86_64
          Maintainer: Lizhixiang <1107664795@qq.com>

          %description
          My cross-platform Flutter app built for CentOS.

          %install
          mkdir -p %{buildroot}/opt/my-desktop-app
          cp -r %{_builddir}/my-desktop-app/* %{buildroot}/opt/my-desktop-app
          # 创建启动器符号链接
          mkdir -p %{buildroot}/usr/bin
          ln -s /opt/my-desktop-app/myapp %{buildroot}/usr/bin/my-desktop-app

          %files
          /opt/my-desktop-app/*
          /usr/bin/my-desktop-app
          EOF

          # 构建 RPM
          rpmbuild -bb ~/rpmbuild/SPECS/my-desktop-app.spec --verbose

          # 移动生成的 RPM 到显式目录
          mkdir -p rpm_packages
          cp ~/rpmbuild/RPMS/x86_64/*.rpm rpm_packages/

      # ------------ 上传构建产物（到 Artifacts） ------------
      - name: Upload artifacts
        uses: actions/upload-artifact@v4.3.1
        with:
          name: centos-package
          path: rpm_packages/*.rpm
            

      # ------------ （可选）发布到 GitHub Releases ------------
    #   - name: Create GitHub Release
    #     if: github.event_name == 'release' && github.event.action == 'created' 
    #     uses: softprops/action-gh-release@v1
    #     with:
    #       files: |
    #         linux_build/*.deb
    #       draft: false
    #       prerelease: false
    #     env:
    #       GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
