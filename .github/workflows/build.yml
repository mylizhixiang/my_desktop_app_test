name: CentOS 7 Desktop App Build
on: 
  push:
    branches: [ main, master ]
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-24.04
    container:
      image: centos:7
      # ====== 关键调整部分 ======
      options: >-
        --security-opt seccomp=unconfined
        --device /dev/dri:/dev/dri
        -v /tmp/.X11-unix:/tmp/.X11-unix

    steps:
    # ========== 系统修复阶段 ==========
    - name: 修复CentOS 7仓库
      run: |
        sed -i.bak \
          's|^mirrorlist=|#mirrorlist=|g;
           s|^#\s*baseurl=http://mirror.centos.org/centos|baseurl=http://vault.centos.org|g' \
          /etc/yum.repos.d/CentOS-*.repo

        rpm --import http://vault.centos.org/RPM-GPG-KEY-CentOS-7
        yum install -y epel-release

    # ========== 开发环境配置 ==========
    - name: 安装构建工具链
      run: |
        yum install -y \
          centos-release-scl \
          devtoolset-11 \
          qt5-qtbase-devel \
          gtk3-devel \
          xorg-x11-server-Xvfb \
          mesa-dri-drivers

    # ========== 构建调试阶段 ==========
    - name: 校验OpenGL支持
      run: |
        glxinfo -B | grep -i 'OpenGL renderer' || true
        Xvfb :99 -screen 0 1024x768x24 &
        export DISPLAY=:99
        xdpyinfo

    # ========== 项目构建流程 ==========
    - name: 检出源码
      uses: actions/checkout@v4

    - name: CMake配置
      run: scl enable devtoolset-11 -- cmake -B build -DCMAKE_BUILD_TYPE=RelWithDebInfo

    - name: 编译应用程序
      run: scl enable devtoolset-11 -- cmake --build build --parallel $(nproc)

    - name: 图形界面测试
      run: |
        Xvfb :99 -screen 0 1280x1024x24 &
        export DISPLAY=:99
        build/myapp --test-gui

    - name: 打包RPM
      run: |
        yum install -y rpm-build
        cmake --build build --target package
        mkdir -p artifacts
        cp build/*.rpm artifacts/

    - name: 上传产物
      uses: actions/upload-artifact@v4.3.3
      with:
        name: centos7-artifacts
        path: artifacts/*.rpm