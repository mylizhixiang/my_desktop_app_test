name: Build Flutter Linux App

on:
  push:
    branches: [main,master]  # 指定触发分支
  pull_request:
    branches: [main,master]
  # 若需通过标签触发发布（可选）
#   release:
#     types: [created]

jobs:
  build-linux:
    runs-on: ubuntu-latest
    container:
      image: centos:7
      options: --privileged

    steps:
      # ------------ 环境准备 ------------
      - name: Checkout code
        uses: actions/checkout@v4

      # ------------ 安装构建依赖 ------------
      - name: Install CentOS dependencies
        run: |
          yum -y update
          yum -y install epel-release
          yum -y install clang cmake ninja-build pkgconfig gtk3-devel rpm-build redhat-rpm-config git

      # ------------ 配置 Flutter SDK ------------
      - name: Setup Flutter
        uses: subosito/flutter-action@v2
        with:
          channel: stable
          cache: true  # 启用包缓存

      # ------------ 配置 Linux 构建支持 ------------
      - name: Enable Linux desktop
        run: flutter config --enable-linux-desktop

      # ------------ 代码测试（可选） ------------
    #   - name: Run tests
    #     run: flutter test

      # ------------ 构建 Release 版本 ------------
      - name: Build Linux app(CentOS兼容)
        run: |
          flutter config --enable-linux-desktop
          flutter build linux --release --target-platform=linux-x64

      # ------------ 打包 RPM 安装包 ------------
      - name: Create RPM package
        run: |
          mkdir -p ~/rpmbuild/{BUILD,RPMS,SOURCES,SPECS,SRPMS}
          # 复制构建产到 BUILD 目录（注意目录名！假设项目名是 "my-desktop-app"）
          cp -r build/linux/x64/release/bundle ~/rpmbuild/BUILD/my-desktop-app
          # 完整写入 SPEC 文件（直接替换名称即可使用）
          echo "%define _topdir $(echo ~)/rpmbuild
          Name: my-desktop-app
          Version: 1.0.0
          Release: 1%{?dist}
          Summary: My Flutter App
          License: MIT
          URL: https://github.com/mylizhixiang/my_desktop_app_test
          Requires: gtk3, libstdc++
          Maintainer: Lizhixiang <1107664795@qq.com>

          %description
          My cross-platform Flutter app built for CentOS.

          %install
          mkdir -p %{buildroot}/usr/bin/my-desktop-app
          cp -r %{_builddir}/myapp/* %{buildroot}/usr/bin/my-desktop-app

          %files
          /usr/bin/my-desktop-app/*
          " > ~/rpmbuild/SPECS/myapp.spec

          # 构建 RPM
          rpmbuild -bb ~/rpmbuild/SPECS/myapp.spec

          # 移动生成的 RPM 到显式目录
          mkdir -p rpm_packages
          cp ~/rpmbuild/RPMS/x86_64/*.rpm rpm_packages/

      # ------------ 上传构建产物（到 Artifacts） ------------
      - name: Upload artifacts
        uses: actions/upload-artifact@v4.3.1
        with:
          name: centos-package
          path: |
            rpm_packages/*.rpm
            build/linux/x64/release/bundle/

      # ------------ （可选）发布到 GitHub Releases ------------
    #   - name: Create GitHub Release
    #     if: github.event_name == 'release' && github.event.action == 'created' 
    #     uses: softprops/action-gh-release@v1
    #     with:
    #       files: |
    #         linux_build/*.deb
    #       draft: false
    #       prerelease: false
    #     env:
    #       GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
