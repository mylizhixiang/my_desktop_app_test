name: CentOS Flutter Build

on:
  push:
    branches: [ main, master ]


jobs:
  build:
    runs-on: ubuntu-latest
    container:
      image: centos:7
      options: --privileged
        -v /var/run/docker.sock:/var/run/docker.sock
        -v /usr/bin/docker:/usr/bin/docker

    steps:
    # ======= Stage 1 - 初始化容器 ======= 
    - name: Prepare Environment
      run: |  # [!code focus:9]
        # 关键步骤：禁用镜像列表，指定源地址
        sed -i.bak \
          -e 's/mirrorlist/#mirrorlist/g' \
          -e 's|#baseurl=http://mirror.centos.org|baseurl=http://vault.centos.org|g' \
          /etc/yum.repos.d/CentOS-*

        # 安装基础工具链（root 用户直接执行）
        yum install -y \
          curl wget which findutils \
          centos-release-scl glibc-langpack-en \
          devtoolset-9-gcc* clang cmake ninja-build

    # ======= Stage 2 - 安装 Flutter =======
    - name: Install Flutter
      run: |
        export FLUTTER_VERSION="3.29.0"
        wget -q https://storage.googleapis.com/flutter_infra_release/releases/stable/linux/flutter_linux_${FLUTTER_VERSION}-stable.tar.xz
        tar -xf flutter_linux_${FLUTTER_VERSION}-stable.tar.xz -C /opt
        echo "/opt/flutter/bin" >> $GITHUB_PATH

    # ======= Stage 3 - 构建应用 =======
    - name: Build Project
      run: |  # [!code focus:3]
        source /opt/rh/devtoolset-9/enable
        flutter config --enable-linux-desktop
        flutter build linux --release
