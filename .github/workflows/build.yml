name: CentOS 7 Desktop App Build
on: 
  push:
    branches: [ main, master ]
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-latest
    container:
      image: centos:7
      options: |
        --privileged
        -v /tmp/.X11-unix:/tmp/.X11-unix

    steps:
    # ========== 环境配置阶段 ==========
    - name: 修复CentOS仓库
      run: |
        sed -i.bak \
          -e 's/mirrorlist=/#mirrorlist=/g' \
          -e 's|#baseurl=http://mirror.centos.org|baseurl=http://vault.centos.org|g' \
          -e 's/\$releasever/7.9.2009/g' \
          /etc/yum.repos.d/CentOS-*.repo

    - name: 安装基础工具
      run: |
        yum install -y epel-release
        yum install -y \
          centos-release-scl-2-3.el7.centos \
          devtoolset-9-9.1-1.el7 \
          qt5-qtbase-devel-5.9.7-2.el7 \
          gtk3-devel-3.22.30-6.el7

    # ========== 代码获取阶段 ==========
    - name: 检出代码
      uses: actions/checkout@v4 # 明确版本号
      with:
        fetch-depth: 0

    # ========== 构建阶段 ==========
    - name: 配置CMake项目
      run: |
        scl enable devtoolset-9 -- cmake -B build \
          -DCMAKE_BUILD_TYPE=Release \
          -DCMAKE_INSTALL_PREFIX=/usr

    - name: 编译应用
      run: |
        scl enable devtoolset-9 -- cmake --build build --parallel $(nproc)

    # ========== 测试阶段 ==========
    - name: 安装测试依赖
      run: yum install -y xorg-x11-server-Xvfb-1.20.4-11.el7

    - name: 运行GUI测试
      run: |
        xvfb-run --server-args="-screen 0 1920x1080x24" \
          build/src/myapp --test
        
        # 生成测试截图（需要ImageMagick）
        yum install -y ImageMagick
        import -window root -resize 50% test-screenshot.jpg

    # ========== 打包阶段 ==========
    - name: 生成RPM包
      run: |
        yum install -y rpm-build-4.11.3-48.el7
        cmake --build build --target package
        mkdir -p artifacts
        cp build/*.rpm artifacts/

    # ========== 产物上传阶段 ==========
    - name: 上传二进制包
      uses: actions/upload-artifact@v4.3.3 # 指定精确版本
      with:
        name: release-packages
        path: |
          artifacts/*.rpm
          build/myapp

    - name: 上传测试截图
      uses: actions/upload-artifact@v4.3.3
      with:
        name: test-evidence
        path: test-screenshot.jpg

    # ========== 后验证阶段 ==========
    - name: 安装验证
      run: |
        yum localinstall -y artifacts/*.rpm
        myapp --version
        ldd $(which myapp) | grep "not found" && exit 1 || true
